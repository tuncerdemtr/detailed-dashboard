<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Satış Performans Dashboard</title>
  <!-- SheetJS (XLSX okuma) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- Chart.js (grafikler) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: linear-gradient(135deg, #f2f2ff, #efe9ff, #fdf7ff);
      --card-bg: rgba(255, 255, 255, 0.5);
      --text-main: #2a2555;
      --text-muted: #7a78a2;
      --accent: #8f7bff;
      --accent-soft: rgba(143, 123, 255, 0.16);
      --border: rgba(255, 255, 255, 0.55);
      --shadow: 0 25px 50px rgba(142, 123, 255, 0.25);
      --blur: 28px;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Poppins', 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      background-attachment: fixed;
      color: var(--text-main);
      min-height: 100vh;
      padding: 32px;
    }
    .page {
      max-width: 1200px;
      margin: 0 auto;
      backdrop-filter: blur(var(--blur));
    }
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    .eyebrow {
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 0.5em;
      color: var(--accent);
      margin-bottom: 12px;
    }
    h1 {
      font-size: 36px;
      letter-spacing: 0.04em;
      margin-bottom: 12px;
    }
    .subtitle {
      font-size: 15px;
      color: var(--text-muted);
      max-width: 760px;
      line-height: 1.6;
    }
    .header-chip {
      display: none;
    }
    .upload-area {
      background: var(--card-bg);
      padding: 20px 24px;
      border-radius: 28px;
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 24px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      backdrop-filter: blur(var(--blur));
    }
    .upload-area label {
      font-size: 14px;
      color: var(--text-muted);
      line-height: 1.5;
    }
    input[type="file"] {
      font-size: 13px;
      color: var(--text-main);
    }
    .filters {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 18px;
      margin-bottom: 28px;
      background: var(--card-bg);
      padding: 24px;
      border-radius: 30px;
      align-items: end;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      backdrop-filter: blur(var(--blur));
    }
    @media (max-width: 960px) {
      .filters {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .filter-actions {
        grid-column: span 2;
        justify-content: flex-start;
      }
    }
    @media (max-width: 640px) {
      .filters {
        grid-template-columns: minmax(0, 1fr);
      }
      .filter-actions {
        grid-column: span 1;
      }
      .clear-filters-btn {
        width: 100%;
        text-align: center;
      }
    }
    .filter-group {
      font-size: 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .filter-actions {
      grid-column: span 4;
      display: flex;
      justify-content: flex-end;
    }
    .clear-filters-btn {
      border: none;
      border-radius: 999px;
      padding: 12px 24px;
      font-size: 13px;
      font-weight: 600;
      color: #fff;
      background: linear-gradient(120deg, #9a7bff, #b48bff);
      box-shadow: 0 12px 25px rgba(154, 123, 255, 0.45);
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .clear-filters-btn:hover {
      transform: translateY(-2px) scale(1.01);
      box-shadow: 0 16px 30px rgba(154, 123, 255, 0.55);
    }
    .clear-filters-btn:active {
      transform: translateY(0);
      box-shadow: inset 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .filter-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.3em;
      color: var(--text-muted);
    }
    .filter-group input[type="month"],
    .filter-group select,
    .multi-select-toggle {
      border-radius: 16px;
      border: none;
      padding: 10px 14px;
      font-size: 13px;
      background: rgba(255, 255, 255, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.4);
      box-shadow: inset 4px 4px 16px rgba(255, 255, 255, 0.3), inset -4px -4px 16px rgba(154, 123, 255, 0.08);
      color: var(--text-main);
    }
    .multi-select {
      position: relative;
    }
    .multi-select-toggle {
      width: 100%;
      text-align: left;
      cursor: pointer;
      transition: box-shadow 0.2s ease;
    }
    .multi-select-toggle:after {
      content: '▾';
      float: right;
      color: var(--text-muted);
    }
    .multi-select.open .multi-select-toggle {
      box-shadow: inset 6px 6px 14px rgba(163, 177, 198, 0.55), inset -6px -6px 14px rgba(255, 255, 255, 0.8);
    }
    .multi-select-menu {
      position: absolute;
      top: calc(100% + 6px);
      left: 0;
      width: 100%;
      background: var(--card-bg);
      border-radius: 20px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      padding: 10px;
      backdrop-filter: blur(var(--blur));
      max-height: 240px;
      overflow-y: auto;
      display: none;
      z-index: 20;
    }
    .multi-select.open .multi-select-menu {
      display: block;
    }
    .multi-select-option {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-main);
      padding: 6px 4px;
    }
    .multi-select-option input {
      accent-color: var(--accent);
    }
    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.6fr) minmax(0, 1fr);
      gap: 24px;
      align-items: flex-start;
    }
    .layout-full {
      grid-template-columns: minmax(0, 1fr);
    }
    @media (max-width: 960px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }
    .card {
      background: var(--card-bg);
      border-radius: 32px;
      padding: 24px 28px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      backdrop-filter: blur(var(--blur));
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 16px;
    }
    .card-title {
      font-size: 16px;
      font-weight: 600;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--text-muted);
    }
    .badge {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.2em;
      border-radius: 999px;
      padding: 6px 12px;
      color: var(--accent);
      background: var(--accent-soft);
    }
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 18px;
      margin-bottom: 28px;
    }
    @media (max-width: 1200px) {
      .kpi-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
    @media (max-width: 640px) {
      .kpi-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }
    .kpi-card {
      background: var(--card-bg);
      border-radius: 24px;
      padding: 18px 20px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      backdrop-filter: blur(var(--blur));
    }
    .kpi-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.2em;
      color: var(--text-muted);
    }
    .kpi-value {
      font-size: 24px;
      font-weight: 600;
    }
    .kpi-sub {
      font-size: 12px;
      color: var(--text-muted);
    }
    canvas {
      width: 100% !important;
      height: 260px !important;
    }
    .table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 8px;
    }
    .table th,
    .table td {
      padding: 10px 6px;
      text-align: left;
    }
    .table th {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.2em;
      color: var(--text-muted);
    }
    .table tbody tr {
      border-radius: 16px;
    }
    .table tbody tr:nth-child(odd) {
      background: rgba(255, 255, 255, 0.35);
    }
    .table tbody tr:nth-child(even) {
      background: rgba(148, 126, 255, 0.08);
    }
    .table-scroll {
      --visible-rows: 6;
      --table-row-height: 48px;
      --table-header-height: 52px;
      overflow-y: auto;
      border-radius: 24px;
      box-shadow: inset 8px 8px 24px rgba(149, 126, 255, 0.08), inset -8px -8px 24px rgba(255, 255, 255, 0.35);
      border: 1px solid var(--border);
      backdrop-filter: blur(var(--blur));
      padding: 4px;
      margin-top: 12px;
      max-height: calc(var(--table-header-height) + var(--table-row-height) * var(--visible-rows));
    }
    .table-scroll.rows-5 {
      --visible-rows: 5;
    }
    .table-scroll.rows-10 {
      --visible-rows: 10;
    }
    .table-scroll .table {
      margin-top: 0;
    }
    .table-scroll thead th {
      position: sticky;
      top: 0;
      background: var(--card-bg);
    }
    .muted {
      color: var(--text-muted);
      font-size: 13px;
      margin-top: 12px;
    }
    .status {
      font-size: 12px;
      margin-top: 8px;
      color: var(--text-muted);
    }
    .status span {
      font-weight: 600;
      color: var(--accent);
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="page-header">
      <div>
        <p class="eyebrow">KPI Dashboard</p>
        <h1>Satış Performans Dashboard</h1>
        <p class="subtitle">
          Aşağıya ham satış verisi Excel (xlsx) dosyanı yükle; metrikler, grafikler ve tablolar filtrelere göre otomatik hesaplansın.
        </p>
      </div>
    </div>

    <div class="upload-area">
      <label><strong>Dosya:</strong> İlgili sayfada sütun başlıkları şu şekilde olmalı:
        <code>Net Total</code>, <code>Alış Total</code>, <code>Kanal</code>, <code>Kullanım</code>,
        <code>Proje_Türü</code>, <code>Organizasyon</code>,
        <code>Proje_Durumu</code>, <code>Kapak_Programı</code>,
        <code>İlk_Oluşturma</code>, <code>Kesinleşen_Sipariş_Tarihi</code>,
        <code>Siparişe_Döndü_Mü</code> vb.
      </label>
      <input type="file" id="fileInput" accept=".xlsx,.xls" />
    </div>

  <div class="filters">
    <div class="filter-group">
      <div class="filter-label">Başlangıç (Ay/Yıl)</div>
      <input type="month" id="startMonth" />
    </div>
    <div class="filter-group">
      <div class="filter-label">Bitiş (Ay/Yıl)</div>
      <input type="month" id="endMonth" />
    </div>
    <div class="filter-group">
      <div class="filter-label">Kullanım (K sütunu)</div>
      <div class="multi-select" id="usageMultiSelect">
        <button type="button" class="multi-select-toggle">Tümü</button>
        <div class="multi-select-menu"></div>
      </div>
    </div>
    <div class="filter-group">
      <div class="filter-label">Kanal (O sütunu)</div>
      <div class="multi-select" id="channelMultiSelect">
        <button type="button" class="multi-select-toggle">Tümü</button>
        <div class="multi-select-menu"></div>
      </div>
    </div>
    <div class="filter-group">
      <div class="filter-label">Proje Durumu (S sütunu)</div>
      <div class="multi-select" id="projectStatusMultiSelect">
        <button type="button" class="multi-select-toggle">Tümü</button>
        <div class="multi-select-menu"></div>
      </div>
    </div>
    <div class="filter-group">
      <div class="filter-label">Proje Türü (I sütunu)</div>
      <div class="multi-select" id="projectTypeMultiSelect">
        <button type="button" class="multi-select-toggle">Tümü</button>
        <div class="multi-select-menu"></div>
      </div>
    </div>
    <div class="filter-group filter-actions">
      <button type="button" class="clear-filters-btn" id="clearFiltersBtn">Hepsini temizle</button>
    </div>
  </div>

  <div class="status" id="statusText">
    Henüz dosya yüklenmedi.
  </div>

  <div class="kpi-grid" id="kpiGrid">
    <!-- KPI kartları JS ile doldurulacak -->
  </div>

  <div class="layout">
    <div class="card">
      <div class="card-header">
        <div class="card-title">Aylık Ciro Trend</div>
        <div class="badge">Net Total</div>
      </div>
      <canvas id="monthlyRevenueChart"></canvas>
      <p class="muted">
        Tarih için öncelik: <strong>Kesinleşen_Sipariş_Tarihi</strong>, boş ise <strong>İlk_Oluşturma</strong> kullanılır.
        Filtreler üstteki alanlardan uygulanır.
      </p>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-title">Kanal Bazlı Ciro</div>
        <div class="badge">Kanal</div>
      </div>
      <canvas id="channelRevenueChart"></canvas>
      <p class="muted">Kanal sütunu üzerinden Net Total toplamı (aktif filtrelere göre).</p>
    </div>
  </div>

  <div class="layout" style="margin-top: 20px;">
    <div class="card">
      <div class="card-header">
        <div class="card-title">Kullanım Tipi Bazlı Ciro & Kâr</div>
        <div class="badge">Kullanım</div>
      </div>
      <table class="table" id="usageTable">
        <!-- JS ile doldurulacak -->
      </table>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-title">Proje Türü Bazlı Ciro</div>
        <div class="badge">Proje_Türü</div>
      </div>
      <table class="table" id="projectTypeTable">
        <!-- JS ile doldurulacak -->
      </table>
    </div>
  </div>

  <!-- Satış noktası & Kapak Programı kârlılık tabloları -->
  <div class="layout layout-full" style="margin-top: 20px;">
    <div class="card">
      <div class="card-header">
        <div class="card-title">Satış Noktası Bazlı Kârlılık</div>
        <div class="badge">Organizasyon (M)</div>
      </div>
      <div class="table-scroll rows-5">
        <table class="table" id="salesPointTable">
          <!-- JS ile doldurulacak -->
        </table>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-title">Kapak Programı Bazlı Kârlılık</div>
        <div class="badge">Kapak_Programı (U)</div>
      </div>
      <div class="table-scroll rows-10">
        <table class="table" id="kapakProgramTable">
          <!-- JS ile doldurulacak -->
        </table>
      </div>
    </div>
  </div>

  <!-- Dönüşüm performansı tabloları -->
  <div class="layout" style="margin-top: 20px;">
    <div class="card">
      <div class="card-header">
        <div class="card-title">Dönüşüm – Kullanım Bazlı</div>
        <div class="badge">Kullanım</div>
      </div>
      <table class="table" id="conversionUsageTable">
        <!-- JS ile doldurulacak -->
      </table>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-title">Dönüşüm – Kanal Bazlı</div>
        <div class="badge">Kanal</div>
      </div>
      <table class="table" id="conversionChannelTable">
        <!-- JS ile doldurulacak -->
      </table>
    </div>
  </div>

  </div>

  <script>
    let rawData = [];
    let monthlyRevenueChart = null;
    let channelRevenueChart = null;

    const fileInput = document.getElementById('fileInput');
    const statusText = document.getElementById('statusText');
    const kpiGrid = document.getElementById('kpiGrid');
    const usageTable = document.getElementById('usageTable');
    const projectTypeTable = document.getElementById('projectTypeTable');
    const salesPointTable = document.getElementById('salesPointTable');
    const kapakProgramTable = document.getElementById('kapakProgramTable');
    const conversionUsageTable = document.getElementById('conversionUsageTable');
    const conversionChannelTable = document.getElementById('conversionChannelTable');

    const startMonthInput = document.getElementById('startMonth');
    const endMonthInput = document.getElementById('endMonth');
    const clearFiltersBtn = document.getElementById('clearFiltersBtn');

    const PROJECT_TYPE_OPTIONS = ['Perakende', 'Toplu İş', 'Teşhir', 'Reklamasyon'];

    const multiSelects = {
      usage: initMultiSelect('usageMultiSelect', processAndRender),
      channel: initMultiSelect('channelMultiSelect', processAndRender),
      projectStatus: initMultiSelect('projectStatusMultiSelect', processAndRender),
      projectType: initMultiSelect('projectTypeMultiSelect', processAndRender)
    };

    multiSelects.projectType.setOptions(PROJECT_TYPE_OPTIONS);

    const COLUMN_ALIASES = {
      'Net Total': ['Net Total', 'Net_Total', 'NetTotal', 'NET TOTAL'],
      'Alış Total': ['Alış Total', 'Alis Total', 'Alış_Total', 'Alis_Total', 'ALIS TOTAL'],
      'Kanal': ['Kanal', 'KANAL', ' Kanal'],
      'Kullanım': ['Kullanım', 'Kullanim', 'KULLANIM'],
      'Proje_Durumu': ['Proje_Durumu', 'Proje Durumu', 'PROJE_DURUMU'],
      'Proje_Türü': ['Proje_Türü', 'Proje Turu', 'Proje Türü', 'PROJE_TURU'],
      'Organizasyon': ['Organizasyon', 'ORGANIZASYON', 'Organizasyon_Tipi', 'Organizasyon Tipi', 'ORGANIZASYON_TIPI', 'Satış Noktası', 'Satis Noktasi'],
      'Kapak_Programı': ['Kapak_Programı', 'Kapak Programı', 'Kapak Programi'],
      'Kesinleşen_Sipariş_Tarihi': ['Kesinleşen_Sipariş_Tarihi', 'Kesinlesen_Siparis_Tarihi', 'Kesinleşen Sipariş Tarihi'],
      'İlk_Oluşturma': ['İlk_Oluşturma', 'Ilk_Olusturma', 'İlk Oluşturma'],
      'Siparis Durumu': ['Siparis Durumu', 'Sipariş Durumu', 'Siparis_Durumu', 'Siparişe_Döndü_Mü']
    };

    function normalizeKeyName(name) {
      return String(name || '').toLocaleLowerCase('tr-TR').replace(/[\s_]/g, '');
    }

    function getColumnValue(row, columnName) {
      if (!row) return null;
      const candidates = COLUMN_ALIASES[columnName] || [columnName];
      for (const candidate of candidates) {
        if (candidate in row) {
          return row[candidate];
        }
      }
      const target = normalizeKeyName(columnName);
      for (const key in row) {
        if (normalizeKeyName(key) === target) {
          return row[key];
        }
      }
      return null;
    }

    function normalizeTextValue(val) {
      if (val === null || val === undefined) return '';
      return String(val).trim();
    }

    function getTextValue(row, columnName) {
      return normalizeTextValue(getColumnValue(row, columnName));
    }

    fileInput.addEventListener('change', handleFile, false);
    startMonthInput.addEventListener('change', () => processAndRender());
    endMonthInput.addEventListener('change', () => processAndRender());
    if (clearFiltersBtn) {
      clearFiltersBtn.addEventListener('click', () => {
        startMonthInput.value = '';
        endMonthInput.value = '';
        Object.values(multiSelects).forEach(ms => {
          if (ms && typeof ms.selectAll === 'function') {
            ms.selectAll(false);
          }
        });
        processAndRender();
      });
    }

    function handleFile(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array', cellDates: true });
          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];
          rawData = XLSX.utils.sheet_to_json(worksheet, { defval: null });
          statusText.innerHTML = `Yüklenen dosya: <span>${file.name}</span> – Satır sayısı: <span>${rawData.length}</span>`;
          populateFilterOptions();
          processAndRender();
        } catch (err) {
          console.error(err);
          statusText.textContent = "Dosya okunurken hata oluştu. Sütun isimlerini ve formatı kontrol et.";
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function populateFilterOptions() {
      const usageSet = new Set();
      const channelSet = new Set();
      const projectStatusSet = new Set();

      rawData.forEach(row => {
        const usage = getTextValue(row, 'Kullanım');
        const channel = getTextValue(row, 'Kanal');
        const projectStatus = getTextValue(row, 'Proje_Durumu');
        if (usage) usageSet.add(usage);
        if (channel) channelSet.add(channel);
        if (projectStatus) projectStatusSet.add(projectStatus);
      });

      multiSelects.usage.setOptions(Array.from(usageSet).sort());
      multiSelects.channel.setOptions(Array.from(channelSet).sort());
      multiSelects.projectStatus.setOptions(Array.from(projectStatusSet).sort());
    }

    function initMultiSelect(id, onChange) {
      const container = document.getElementById(id);
      const toggle = container.querySelector('.multi-select-toggle');
      const menu = container.querySelector('.multi-select-menu');
      let options = [];
      let selected = new Set();

      function updateToggleLabel() {
        if (options.length === 0) {
          toggle.textContent = 'Seçenek yok';
          toggle.disabled = true;
          return;
        }
        toggle.disabled = false;
        if (selected.size === options.length) {
          toggle.textContent = 'Tümü';
        } else if (selected.size === 0) {
          toggle.textContent = 'Seçiniz';
        } else {
          toggle.textContent = `${selected.size} seçili`;
        }
      }

      function notifyChange() {
        if (typeof onChange === 'function') {
          onChange();
        }
      }

      function renderMenu() {
        menu.innerHTML = '';
        if (!options.length) {
          const empty = document.createElement('div');
          empty.className = 'multi-select-option muted';
          empty.textContent = 'Seçenek yok';
          menu.appendChild(empty);
          updateToggleLabel();
          return;
        }

        options.forEach(val => {
          const label = document.createElement('label');
          label.className = 'multi-select-option';
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.value = val;
          checkbox.checked = selected.has(val);
          checkbox.addEventListener('change', () => {
            if (checkbox.checked) {
              selected.add(val);
            } else {
              selected.delete(val);
            }
            updateToggleLabel();
            notifyChange();
          });
          label.appendChild(checkbox);
          const span = document.createElement('span');
          span.textContent = val;
          label.appendChild(span);
          menu.appendChild(label);
        });
        updateToggleLabel();
      }

      toggle.addEventListener('click', (event) => {
        event.stopPropagation();
        container.classList.toggle('open');
      });

      document.addEventListener('click', (event) => {
        if (!container.contains(event.target)) {
          container.classList.remove('open');
        }
      });

      renderMenu();

      return {
        setOptions(newOptions) {
          options = newOptions;
          selected = new Set(newOptions);
          renderMenu();
        },
        getSelected() {
          return Array.from(selected);
        },
        isAllSelected() {
          return selected.size === options.length || options.length === 0;
        },
        selectAll(shouldNotify = true) {
          selected = new Set(options);
          renderMenu();
          if (shouldNotify) {
            notifyChange();
          }
        }
      };
    }

    function parseNumber(val) {
      if (val === null || val === undefined) return 0;
      if (typeof val === 'number') return val;
      if (typeof val === 'string') {
        let s = val.trim();
        if (!s) return 0;
        s = s.replace(/\./g, '').replace(',', '.');
        const num = parseFloat(s);
        return isNaN(num) ? 0 : num;
      }
      return 0;
    }

    function isOrderFromZ(val) {
      if (val === null || val === undefined) return false;
      const n = Number(val);
      return n === 1;
    }

    function getDate(val) {
      if (!val) return null;
      if (val instanceof Date) return val;
      if (typeof val === 'number') {
        const epoch = new Date(Date.UTC(1899, 11, 30));
        const d = new Date(epoch.getTime() + val * 86400000);
        return d;
      }
      const d = new Date(val);
      if (isNaN(d.getTime())) return null;
      return d;
    }

    function getEffectiveDate(row) {
      const finalized = getDate(getColumnValue(row, 'Kesinleşen_Sipariş_Tarihi'));
      const created = getDate(getColumnValue(row, 'İlk_Oluşturma'));
      return finalized || created || null;
    }

    function getMonthKey(row) {
      const d = getEffectiveDate(row);
      if (!d) return null;
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      return `${year}-${month}`;
    }

    function formatCurrency(val) {
      return val.toLocaleString('tr-TR', {
        style: 'currency',
        currency: 'TRY',
        maximumFractionDigits: 0
      });
    }

    function formatPercent(val) {
      if (!isFinite(val)) return '–';
      return (val * 100).toFixed(1) + ' %';
    }

    function getFilteredData() {
      if (!rawData || rawData.length === 0) return [];

      const startVal = startMonthInput.value; // "YYYY-MM"
      const endVal = endMonthInput.value;

      let startYM = null;
      let endYM = null;

      if (startVal) {
        const [y, m] = startVal.split('-').map(Number);
        startYM = y * 100 + m;
      }
      if (endVal) {
        const [y, m] = endVal.split('-').map(Number);
        endYM = y * 100 + m;
      }

      const usageValues = multiSelects.usage.getSelected();
      const channelValues = multiSelects.channel.getSelected();
      const projectStatusValues = multiSelects.projectStatus.getSelected();
      const projectTypeValues = multiSelects.projectType.getSelected();

      const usageSelectedSet = new Set(usageValues);
      const channelSelectedSet = new Set(channelValues);
      const projectStatusSelectedSet = new Set(projectStatusValues);
      const projectTypeSelectedSet = new Set(projectTypeValues);

      const usageFilterActive = !multiSelects.usage.isAllSelected();
      const channelFilterActive = !multiSelects.channel.isAllSelected();
      const projectStatusFilterActive = !multiSelects.projectStatus.isAllSelected();
      const projectTypeFilterActive = !multiSelects.projectType.isAllSelected();

      return rawData.filter(row => {
        const d = getEffectiveDate(row);
        if (d) {
          const ym = d.getFullYear() * 100 + (d.getMonth() + 1);
          if (startYM !== null && ym < startYM) return false;
          if (endYM !== null && ym > endYM) return false;
        } else {
          if (startYM !== null || endYM !== null) return false;
        }

        const usage = getTextValue(row, 'Kullanım');
        const channel = getTextValue(row, 'Kanal');
        const projectStatus = getTextValue(row, 'Proje_Durumu');
        const projectType = getTextValue(row, 'Proje_Türü');

        if (usageFilterActive && (!usage || !usageSelectedSet.has(usage))) return false;
        if (channelFilterActive && (!channel || !channelSelectedSet.has(channel))) return false;
        if (projectStatusFilterActive && (!projectStatus || !projectStatusSelectedSet.has(projectStatus))) return false;
        if (projectTypeFilterActive && (!projectType || !projectTypeSelectedSet.has(projectType))) return false;

        return true;
      });
    }

    function processAndRender() {
      const data = getFilteredData();
      if (!data || data.length === 0) {
        kpiGrid.innerHTML = '';
        usageTable.innerHTML = '';
        projectTypeTable.innerHTML = '';
        salesPointTable.innerHTML = '';
        kapakProgramTable.innerHTML = '';
        conversionUsageTable.innerHTML = '';
        conversionChannelTable.innerHTML = '';
        if (monthlyRevenueChart) monthlyRevenueChart.destroy();
        if (channelRevenueChart) channelRevenueChart.destroy();
        statusText.innerHTML = 'Aktif filtrelerle gösterilecek satır bulunamadı.';
        return;
      }

      let totalRevenue = 0;
      let totalCost = 0;
      let orderCount = 0;
      let offerCount = 0;
      let rowsWithMoney = 0;

      const byMonth = {};
      const byChannel = {};
      const byUsage = {};
      const byProjectType = {};
      const bySalesPoint = {};
      const byKapakProgram = {};

      data.forEach(row => {
        const revenue = parseNumber(getColumnValue(row, 'Net Total'));
        const cost = parseNumber(getColumnValue(row, 'Alış Total'));
        const isOrder = isOrderFromZ(getColumnValue(row, 'Siparis Durumu'));

        if (revenue !== 0 || cost !== 0) {
          rowsWithMoney++;
        }

        totalRevenue += revenue;
        totalCost += cost;
        if (isOrder) {
          orderCount++;
        } else {
          offerCount++;
        }

        const monthKey = getMonthKey(row);
        if (monthKey) {
          if (!byMonth[monthKey]) {
            byMonth[monthKey] = { revenue: 0, orders: 0 };
          }
          byMonth[monthKey].revenue += revenue;
          if (isOrder) byMonth[monthKey].orders++;
        }

        const channel = getTextValue(row, 'Kanal') || 'Belirsiz';
        if (!byChannel[channel]) {
          byChannel[channel] = { revenue: 0, orders: 0, total: 0 };
        }
        byChannel[channel].revenue += revenue;
        byChannel[channel].total++;
        if (isOrder) byChannel[channel].orders++;

        const usage = getTextValue(row, 'Kullanım') || 'Belirsiz';
        if (!byUsage[usage]) {
          byUsage[usage] = { revenue: 0, cost: 0, orders: 0, total: 0 };
        }
        byUsage[usage].revenue += revenue;
        byUsage[usage].cost += cost;
        byUsage[usage].total++;
        if (isOrder) byUsage[usage].orders++;

        const pType = getTextValue(row, 'Proje_Türü') || 'Belirsiz';
        if (!byProjectType[pType]) {
          byProjectType[pType] = { revenue: 0, orders: 0, total: 0 };
        }
        byProjectType[pType].revenue += revenue;
        byProjectType[pType].total++;
        if (isOrder) byProjectType[pType].orders++;

        const salesPoint = getTextValue(row, 'Organizasyon') || 'Belirsiz';
        if (!bySalesPoint[salesPoint]) {
          bySalesPoint[salesPoint] = { revenue: 0, cost: 0, orders: 0, total: 0 };
        }
        bySalesPoint[salesPoint].revenue += revenue;
        bySalesPoint[salesPoint].cost += cost;
        bySalesPoint[salesPoint].total++;
        if (isOrder) bySalesPoint[salesPoint].orders++;

        const kapak = getTextValue(row, 'Kapak_Programı') || 'Belirsiz';
        if (!byKapakProgram[kapak]) {
          byKapakProgram[kapak] = { revenue: 0, cost: 0, orders: 0, total: 0 };
        }
        byKapakProgram[kapak].revenue += revenue;
        byKapakProgram[kapak].cost += cost;
        byKapakProgram[kapak].total++;
        if (isOrder) byKapakProgram[kapak].orders++;
      });

      const totalProfit = totalRevenue - totalCost;
      const grossMargin = totalRevenue > 0 ? totalProfit / totalRevenue : 0;
      const avgOrderValue = orderCount > 0 ? totalRevenue / orderCount : 0;
      const conversionRate = (orderCount + offerCount) > 0 ? orderCount / (orderCount + offerCount) : 0;

      renderKPIs({
        totalRevenue,
        totalCost,
        totalProfit,
        grossMargin,
        orderCount,
        offerCount,
        avgOrderValue,
        conversionRate,
        rowsWithMoney
      });

      renderMonthlyRevenueChart(byMonth);
      renderChannelRevenueChart(byChannel);
      renderUsageTable(byUsage);
      renderProjectTypeTable(byProjectType);
      renderSalesPointTable(bySalesPoint);
      renderKapakProgramTable(byKapakProgram);
      renderConversionUsageTable(byUsage);
      renderConversionChannelTable(byChannel);
    }

    function renderKPIs(m) {
      kpiGrid.innerHTML = '';

      const items = [
        {
          label: 'Toplam Ciro',
          value: formatCurrency(m.totalRevenue),
          sub: `Satır sayısı (parasal): ${m.rowsWithMoney}`
        },
        {
          label: 'Toplam Brüt Kâr',
          value: formatCurrency(m.totalProfit),
          sub: `Brüt marj: ${formatPercent(m.grossMargin)}`
        },
        {
          label: 'Sipariş Adedi',
          value: m.orderCount.toLocaleString('tr-TR'),
          sub: `Teklif + Sipariş: ${(m.orderCount + m.offerCount).toLocaleString('tr-TR')}`
        },
        {
          label: 'Ort. Sipariş Tutarı',
          value: m.avgOrderValue ? formatCurrency(m.avgOrderValue) : '–',
          sub: `Dönüşüm oranı: ${formatPercent(m.conversionRate)}`
        }
      ];

      items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'kpi-card';
        div.innerHTML = `
          <div class="kpi-label">${item.label}</div>
          <div class="kpi-value">${item.value}</div>
          <div class="kpi-sub">${item.sub}</div>
        `;
        kpiGrid.appendChild(div);
      });
    }

    function renderMonthlyRevenueChart(byMonth) {
      const ctx = document.getElementById('monthlyRevenueChart').getContext('2d');
      const keys = Object.keys(byMonth).sort();
      const labels = keys;
      const dataRevenue = keys.map(k => byMonth[k].revenue);

      if (monthlyRevenueChart) {
        monthlyRevenueChart.destroy();
      }

      monthlyRevenueChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Net Total',
            data: dataRevenue
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              ticks: {
                callback: function (value) {
                  return value.toLocaleString('tr-TR');
                }
              }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: function (context) {
                  return ' Ciro: ' + formatCurrency(context.parsed.y);
                }
              }
            },
            legend: {
              display: false
            }
          }
        }
      });
    }

    function renderChannelRevenueChart(byChannel) {
      const ctx = document.getElementById('channelRevenueChart').getContext('2d');
      const entries = Object.entries(byChannel)
        .sort((a, b) => b[1].revenue - a[1].revenue)
        .slice(0, 10);

      const labels = entries.map(e => e[0]);
      const dataRevenue = entries.map(e => e[1].revenue);

      if (channelRevenueChart) {
        channelRevenueChart.destroy();
      }

      channelRevenueChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Net Total',
            data: dataRevenue
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              ticks: {
                callback: function (value) {
                  return value.toLocaleString('tr-TR');
                }
              }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: function (context) {
                  return ' Ciro: ' + formatCurrency(context.parsed.x);
                }
              }
            },
            legend: {
              display: false
            }
          }
        }
      });
    }

    function renderUsageTable(byUsage) {
      const entries = Object.entries(byUsage)
        .sort((a, b) => b[1].revenue - a[1].revenue);

      let html = `
        <thead>
          <tr>
            <th>Kullanım</th>
            <th>Ciro</th>
            <th>Brüt Kâr</th>
            <th>Brüt Marj</th>
            <th>Sipariş Adedi</th>
          </tr>
        </thead>
        <tbody>
      `;

      entries.forEach(([usage, obj]) => {
        const profit = obj.revenue - obj.cost;
        const margin = obj.revenue > 0 ? profit / obj.revenue : 0;
        html += `
          <tr>
            <td>${usage}</td>
            <td>${formatCurrency(obj.revenue)}</td>
            <td>${formatCurrency(profit)}</td>
            <td>${formatPercent(margin)}</td>
            <td>${obj.orders.toLocaleString('tr-TR')}</td>
          </tr>
        `;
      });

      html += '</tbody>';
      usageTable.innerHTML = html;
    }

    function renderProjectTypeTable(byProjectType) {
      const entries = Object.entries(byProjectType)
        .sort((a, b) => b[1].revenue - a[1].revenue);

      let html = `
        <thead>
          <tr>
            <th>Proje Türü</th>
            <th>Ciro</th>
            <th>Sipariş Adedi</th>
          </tr>
        </thead>
        <tbody>
      `;

      entries.forEach(([type, obj]) => {
        html += `
          <tr>
            <td>${type}</td>
            <td>${formatCurrency(obj.revenue)}</td>
            <td>${obj.orders.toLocaleString('tr-TR')}</td>
          </tr>
        `;
      });

      html += '</tbody>';
      projectTypeTable.innerHTML = html;
    }

    function renderSalesPointTable(bySalesPoint) {
      const entries = Object.entries(bySalesPoint)
        .sort((a, b) => b[1].revenue - a[1].revenue);

      let html = `
        <thead>
          <tr>
            <th>Satış Noktası</th>
            <th>Ciro</th>
            <th>Brüt Kâr</th>
            <th>Brüt Marj</th>
            <th>Sipariş Adedi</th>
          </tr>
        </thead>
        <tbody>
      `;

      entries.forEach(([salesPoint, obj]) => {
        const profit = obj.revenue - obj.cost;
        const margin = obj.revenue > 0 ? profit / obj.revenue : 0;
        html += `
          <tr>
            <td>${salesPoint}</td>
            <td>${formatCurrency(obj.revenue)}</td>
            <td>${formatCurrency(profit)}</td>
            <td>${formatPercent(margin)}</td>
            <td>${obj.orders.toLocaleString('tr-TR')}</td>
          </tr>
        `;
      });

      html += '</tbody>';
      salesPointTable.innerHTML = html;
    }

    function renderKapakProgramTable(byKapakProgram) {
      const entries = Object.entries(byKapakProgram)
        .sort((a, b) => b[1].revenue - a[1].revenue);

      let html = `
        <thead>
          <tr>
            <th>Kapak Programı</th>
            <th>Ciro</th>
            <th>Brüt Kâr</th>
            <th>Brüt Marj</th>
            <th>Sipariş Adedi</th>
            <th>Dönüşüm Oranı</th>
          </tr>
        </thead>
        <tbody>
      `;

      entries.forEach(([kp, obj]) => {
        const profit = obj.revenue - obj.cost;
        const margin = obj.revenue > 0 ? profit / obj.revenue : 0;
        const conv = obj.total > 0 ? obj.orders / obj.total : 0;
        html += `
          <tr>
            <td>${kp}</td>
            <td>${formatCurrency(obj.revenue)}</td>
            <td>${formatCurrency(profit)}</td>
            <td>${formatPercent(margin)}</td>
            <td>${obj.orders.toLocaleString('tr-TR')}</td>
            <td>${formatPercent(conv)}</td>
          </tr>
        `;
      });

      html += '</tbody>';
      kapakProgramTable.innerHTML = html;
    }

    function renderConversionUsageTable(byUsage) {
      const entries = Object.entries(byUsage)
        .sort((a, b) => {
          const convA = a[1].total > 0 ? a[1].orders / a[1].total : 0;
          const convB = b[1].total > 0 ? b[1].orders / b[1].total : 0;
          return convB - convA;
        });

      let html = `
        <thead>
          <tr>
            <th>Kullanım</th>
            <th>Teklif + Sipariş</th>
            <th>Sipariş</th>
            <th>Dönüşüm Oranı</th>
            <th>Ort. Sipariş Tutarı</th>
            <th>Ciro</th>
          </tr>
        </thead>
        <tbody>
      `;

      entries.forEach(([usage, obj]) => {
        const conv = obj.total > 0 ? obj.orders / obj.total : 0;
        const avgOrder = obj.orders > 0 ? obj.revenue / obj.orders : 0;
        html += `
          <tr>
            <td>${usage}</td>
            <td>${obj.total.toLocaleString('tr-TR')}</td>
            <td>${obj.orders.toLocaleString('tr-TR')}</td>
            <td>${formatPercent(conv)}</td>
            <td>${avgOrder ? formatCurrency(avgOrder) : '–'}</td>
            <td>${formatCurrency(obj.revenue)}</td>
          </tr>
        `;
      });

      html += '</tbody>';
      conversionUsageTable.innerHTML = html;
    }

    function renderConversionChannelTable(byChannel) {
      const entries = Object.entries(byChannel)
        .sort((a, b) => {
          const convA = a[1].total > 0 ? a[1].orders / a[1].total : 0;
          const convB = b[1].total > 0 ? b[1].orders / b[1].total : 0;
          return convB - convA;
        });

      let html = `
        <thead>
          <tr>
            <th>Kanal</th>
            <th>Teklif + Sipariş</th>
            <th>Sipariş</th>
            <th>Dönüşüm Oranı</th>
            <th>Ort. Sipariş Tutarı</th>
            <th>Ciro</th>
          </tr>
        </thead>
        <tbody>
      `;

      entries.forEach(([channel, obj]) => {
        const conv = obj.total > 0 ? obj.orders / obj.total : 0;
        const avgOrder = obj.orders > 0 ? obj.revenue / obj.orders : 0;
        html += `
          <tr>
            <td>${channel}</td>
            <td>${obj.total.toLocaleString('tr-TR')}</td>
            <td>${obj.orders.toLocaleString('tr-TR')}</td>
            <td>${formatPercent(conv)}</td>
            <td>${avgOrder ? formatCurrency(avgOrder) : '–'}</td>
            <td>${formatCurrency(obj.revenue)}</td>
          </tr>
        `;
      });

      html += '</tbody>';
      conversionChannelTable.innerHTML = html;
    }
  </script>
</body>
</html>
